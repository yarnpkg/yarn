version: 2
jobs:
  build:
    docker: 
      - image: yarnpkg/dev:latest
    working_directory: /home/ubuntu/yarn
    steps:
      - checkout
      - restore_cache:
          key: yarn-{{ .Branch }}-{{ checksum "yarn.lock" }}
      - run:
          name: Install Dependencies
          command: yarn install
      - run:
          name: Tests
          command: |
            node -v
            if [ "$CIRCLE_BRANCH" == 'master' ]; then
              ./scripts/set-dev-version.js
            fi;
            yarn lint
            yarn test-ci -- -- --maxWorkers 3
            yarn check-lockfile
            yarn build-dist
            node ./scripts/build-webpack.js
            ./scripts/build-deb.sh
      - save_cache:
          key: yarn-{{ .Branch }}-{{ checksum "yarn.lock" }}
          paths:
            - "~/.yarn-cache"
      - store_artifacts:
          path: artifacts/
          destination: yarnpkg
      - deploy:
          name: Deploy
          command: |
            if [ "${CIRCLE_PROJECT_USERNAME}" == "yarnpkg" ]; then
              if git log -1 --pretty=%B | grep "^v[0-9]\+\.[0-9]\+\.[0-9]\+$"; then
                echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
                ./scripts/set-installation-method.js "`pwd`/package.json" npm
                npm publish --tag rc
              fi
            fi

notify:
  webhooks:
    # Handles uploading stable/RC releases to GitHub
    - url: https://nightly.yarnpkg.com/release_circleci
    # Handles archiving all builds onto the nightly build site
    - url: https://nightly.yarnpkg.com/archive_circleci
